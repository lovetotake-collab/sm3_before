<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM3 ë§¤ë§¤ ê³„ì‚°ê¸° v16 (ë„ë‹¬ê³ ì •)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .line-item {
            padding: 12px;
            margin: 6px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: all 0.2s;
        }
        .line-item:hover {
            transform: translateX(4px);
        }
        .sm-line { background: #dcfce7; border-left: 4px solid #22c55e; }
        .sm2-line { background: #fef9c3; border-left: 4px solid #eab308; }
        .sm3-line { background: #fed7aa; border-left: 4px solid #f97316; }
        .sm4-line { background: #fecdd3; border-left: 4px solid #dc2626; }
        .sell-line { background: #fecaca; border-left: 4px solid #ef4444; }
        .buy-point { background: #fee2e2; border: 2px solid #ef4444; font-weight: 700; }
        .sell-point { background: #dbeafe; border: 2px solid #3b82f6; font-weight: 700; }
        
        input[type="text"], input[type="number"] {
            border: 2px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .input-gray { background: #f3f4f6; border-color: #9ca3af; }
        .input-red { background: #fee2e2; border-color: #fca5a5; }
        .input-blue { background: #dbeafe; border-color: #93c5fd; }
        .input-purple { background: #e9d5ff; border-color: #c084fc; }
        .input-green { background: #d1fae5; border-color: #6ee7b7; }
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-calculate:active {
            transform: translateY(0);
        }
        .btn-reset {
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reset:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }
        
        .stock-list-item {
            background: #f9fafb;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .stock-list-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }
        .stock-list-item.selected {
            background: #e0e7ff;
            border-color: #667eea;
        }
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 0 8px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #667eea;
        }
        
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }
        
        .summary-box {
            background: #fef9c3;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #facc15;
            margin-bottom: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th {
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #667eea;
            position: sticky;
            top: 0;
        }
        table td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        table tr:hover {
            background: #f9fafb;
        }
        
        /* ì‹¤ì‹œê°„ ì‹œì„¸ ìŠ¤íƒ€ì¼ */
        .price-up { color: #dc2626; font-weight: bold; }
        .price-down { color: #2563eb; font-weight: bold; }
        .price-flat { color: #1f2937; font-weight: bold; }
        
        /* ë§¤ìˆ˜íƒ€ì  ë„ë‹¬ í‘œì‹œ */
        .price-reached {
            color: #dc2626;
            text-decoration: line-through;
            font-weight: bold;
        }
        
        /* ê·¼ì ‘ (í˜„ì¬ê°€ > ë§¤ìˆ˜íƒ€ì ): ë…¹ìƒ‰ ë°•ìŠ¤ */
        .proximity-box {
            background: #bbf7d0;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 4px 8px;
            animation: glow-green 1.5s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes glow-green {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        
        /* ë„ë‹¬ (í˜„ì¬ê°€ â‰ˆ ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ë°•ìŠ¤ */
        .proximity-box-equal {
            background: #fed7aa;
            border: 2px solid #f97316;
            border-radius: 8px;
            padding: 4px 8px;
            animation: glow-orange 1.5s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes glow-orange {
            0%, 100% { box-shadow: 0 0 5px rgba(249, 115, 22, 0.5); }
            50% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.8); }
        }
        
        /* ë„ë‹¬ ì´í•˜ (í˜„ì¬ê°€ < ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ì‹¤ì„  ë°•ìŠ¤ */
        .proximity-box-below {
            background: white;
            border: 2px solid #f97316;
            border-radius: 8px;
            padding: 4px 8px;
            display: inline-block;
            color: #f97316;
            font-weight: bold;
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
        }
        .api-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .api-status.connected::before {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }
        .api-status.disconnected::before {
            background: #ef4444;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
        }
        .sync-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .sync-status.connected::before {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }
        .sync-status.disconnected::before {
            background: #6b7280;
        }
        .sync-status.syncing::before {
            background: #eab308;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ë””í…Œì¼ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .detail-item {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* ì•Œë¦¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .alert-settings-btn {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        .alert-settings-btn:hover {
            background: #d97706;
        }
        
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .alert-modal.active {
            display: flex;
        }
        .alert-modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <div class="card">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold mb-2 flex items-center gap-3">
                        <span class="text-4xl">ğŸ“Š</span>
                        <span class="bg-gradient-to-r from-purple-600 to-blue-600 text-transparent bg-clip-text">
                            SMë¼ì¸ ë§¤ë§¤ ê³„ì‚°ê¸° v7
                        </span>
                    </h1>
                    <p class="text-gray-600 text-sm">
                        ì¢…ëª© ê´€ë¦¬ ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ê³ ê¸‰ ë²„ì „ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™” + í‚¤ì›€ API ì‹¤ì‹œê°„ ì‹œì„¸)
                    </p>
                </div>
                <div class="flex gap-3">
                    <button onclick="manualBackup()" id="backupBtn" disabled
                            class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        ğŸ’¾ ë°±ì—…
                    </button>
                    <button onclick="manualLoad()" id="loadBtn" disabled
                            class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        ğŸ“¥ ë¡œë“œ
                    </button>
                    <button onclick="handleGoogleAuth()" 
                            class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        <span id="googleBtnText">ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸</span>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <button id="alertSettingsBtn" class="alert-settings-btn" onclick="openAlertSettings()">
                        <span>ğŸ””</span>
                        <span>ì•Œë¦¼ ì„¤ì •</span>
                    </button>
                    <div id="syncStatus" class="sync-status disconnected">
                        <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                    <div id="apiStatus" class="api-status disconnected">
                        <span id="apiStatusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                </div>
                <div id="lastSyncTime" class="text-xs text-gray-500"></div>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                ğŸ“ ì¢…ëª© ì •ë³´ ì…ë ¥
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="ì¢…ëª©ëª… ì…ë ¥"
                           class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">ì¢…ëª©ì½”ë“œ</label>
                    <input type="text" id="stockCode" placeholder="ì¢…ëª©ì½”ë“œ (ì„ íƒ)"
                           class="input-gray">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-red-600">ê³ ê°€(â‚©)</label>
                    <input type="text" id="highPrice" placeholder="ê³ ê°€ì…ë ¥"
                           class="input-red">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-blue-600">ì €ê°€ (â‚©)</label>
                    <input type="text" id="lowPrice" placeholder="ì €ê°€ ì…ë ¥"
                           class="input-blue">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-purple-600">ë°˜ë“±ì €ê°€ (â‚©)</label>
                    <input type="text" id="bouncePrice" placeholder="ì„ íƒì‚¬í•­"
                           class="input-purple">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-green-600">ìˆ˜ì •ì €ê°€ (â‚©)</label>
                    <input type="text" id="adjustedPrice" placeholder="ì„ íƒì‚¬í•­"
                           class="input-green">
                </div>
            </div>

            <div class="flex gap-3 flex-wrap">
                <button onclick="calculate()" class="btn-calculate flex-1 min-w-[200px]">
                    âœ… ê³„ì‚°í•˜ê¸°
                </button>
                <button onclick="addToList()" class="btn-calculate flex-1 min-w-[200px]"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ’¾ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                </button>
                <button onclick="resetInputs()" class="btn-reset">
                    ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”
                </button>
            </div>
            
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    ğŸ’¡ íŒ: ê³ ê°€, ì €ê°€ë§Œ ì…ë ¥í•´ë„ SMë¼ì¸ê³¼ ë§¤ìˆ˜íƒ€ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“±ì €ê°€ë¥¼ ì…ë ¥í•˜ë©´ ë§¤ë„íƒ€ì ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                ğŸ“‹ ì €ì¥ëœ ì¢…ëª© ë¦¬ìŠ¤íŠ¸
            </h2>
            <p class="text-sm text-gray-600 mb-4">ì¢…ëª©ì„ í´ë¦­í•˜ë©´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</p>
            <div id="stockList"></div>
        </div>
        
        <div id="stockDetail" class="card" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                ğŸ“Œ <span id="detailStockName"></span> ìƒì„¸ì •ë³´
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="detail-card" style="background: white; border: 3px solid #f59e0b; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-orange-600 flex items-center gap-2">
                        <span style="font-size: 20px;">âš ï¸</span>
                        <span>ë§¤ë§¤íƒ€ì  ìš”ì•½</span>
                    </h4>
                    <div class="bg-yellow-50 p-3 rounded-lg mb-3" style="background: #fef9c3;">
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <div class="text-xs text-gray-600 mb-1">ì¢…ëª©ëª…</div>
                                <div class="font-bold text-base" id="summaryStockName" style="color: #1f2937;"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-600 mb-1">ìƒìŠ¹ë¥ </div>
                                <div class="font-bold text-base" id="summaryPriceRate" style="color: #1f2937;"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-600 mb-1">ë°˜ë“±í­</div>
                                <div class="font-bold text-base" id="summaryBounceRate" style="color: #7c3aed;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-600 font-bold" style="font-size: 14px;">ğŸ”´ ë§¤ìˆ˜ íƒ€ì  & ì†ì ˆ</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-3 rounded-lg" style="background: #fee2e2; border: 2px solid #fecaca;">
                                <div class="text-xs text-gray-600 mb-1">1ì°¨ ë§¤ìˆ˜</div>
                                <div class="text-xs text-gray-500 mb-1">(SM2ë¼ì¸ 4ë‹¨ìœ„)</div>
                                <div id="summaryBuy1" class="font-bold text-lg text-red-600"></div>
                            </div>
                            <div class="p-3 rounded-lg" style="background: #fee2e2; border: 2px solid #fecaca;">
                                <div class="text-xs text-gray-600 mb-1">2ì°¨ ë§¤ìˆ˜</div>
                                <div class="text-xs text-gray-500 mb-1">(SM2ë¼ì¸ 5ë‹¨ìœ„)</div>
                                <div id="summaryBuy2" class="font-bold text-lg text-red-600"></div>
                            </div>
                            <div class="p-3 rounded-lg" style="background: #fee2e2; border: 2px solid #fecaca;">
                                <div class="text-xs text-gray-600 mb-1">3ì°¨ ë§¤ìˆ˜</div>
                                <div class="text-xs text-gray-500 mb-1">(SM3ë¼ì¸ 4ë‹¨ìœ„)</div>
                                <div id="summaryBuy3" class="font-bold text-lg text-red-600"></div>
                            </div>
                            <div class="p-3 rounded-lg" style="background: #fee2e2; border: 2px solid #fecaca;">
                                <div class="text-xs text-gray-600 mb-1">4ì°¨ ë§¤ìˆ˜</div>
                                <div class="text-xs text-gray-500 mb-1">(SM3ë¼ì¸ 5ë‹¨ìœ„)</div>
                                <div id="summaryBuy4" class="font-bold text-lg text-red-600"></div>
                            </div>
                        </div>
                        <div class="mt-2 p-3 rounded-lg" style="background: #f3f4f6; border: 2px solid #e5e7eb;">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-xs text-gray-600">ì†ì ˆ</div>
                                    <div class="text-xs text-gray-500">(SM4ë¼ì¸ 2ë‹¨ìœ„)</div>
                                </div>
                                <div id="summaryStopLoss" class="font-bold text-lg" style="color: #374151;"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-blue-600 font-bold" style="font-size: 14px;">ğŸ”µ ë§¤ë„ íƒ€ì </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-3 rounded-lg" style="background: #dbeafe; border: 2px solid #bfdbfe;">
                                <div class="text-xs text-gray-600 mb-1">1ì°¨ ë§¤ë„</div>
                                <div class="text-xs text-gray-500 mb-1" id="sell1Description">(ë§¤ë„ë¼ì¸ 3ë‹¨ìœ„)</div>
                                <div id="summarySell1" class="font-bold text-lg text-blue-600"></div>
                            </div>
                            <div class="p-3 rounded-lg" style="background: #dbeafe; border: 2px solid #bfdbfe;">
                                <div class="text-xs text-gray-600 mb-1">2ì°¨ ë§¤ë„</div>
                                <div class="text-xs text-gray-500 mb-1" id="sell2Description">(ë§¤ë„ë¼ì¸ 2ë‹¨ìœ„)</div>
                                <div id="summarySell2" class="font-bold text-lg text-blue-600"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="detail-card" style="background: white; border: 2px solid #ec4899; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-pink-700 flex items-center gap-2">
                        <span>ğŸ’™ ë§¤ë„ë¼ì¸</span>
                    </h4>
                    <div class="space-y-2">
                        <div class="detail-item" style="background: #fce7f3; padding: 10px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div class="flex justify-between">
                                <span>1ë‹¨ìœ„:</span>
                                <span id="sell_line_1" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fce7f3; padding: 10px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div class="flex justify-between items-center">
                                <span>2ë‹¨ìœ„ <span class="text-blue-600 text-sm">â† 2ì°¨ ë§¤ë„</span></span>
                                <span id="sell_line_2" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fce7f3; padding: 10px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div class="flex justify-between items-center">
                                <span>3ë‹¨ìœ„ <span class="text-blue-600 text-sm">â† 1ì°¨ ë§¤ë„</span></span>
                                <span id="sell_line_3" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fce7f3; padding: 10px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div class="flex justify-between">
                                <span>4ë‹¨ìœ„:</span>
                                <span id="sell_line_4" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fce7f3; padding: 10px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div class="flex justify-between">
                                <span>5ë‹¨ìœ„ (ë°˜ë“±ì €ê°€):</span>
                                <span id="sell_line_5" class="font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="detail-card" style="background: white; border: 2px solid #22c55e; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-green-700 flex items-center gap-2">
                        <span>âš« SMë¼ì¸</span>
                    </h4>
                    <div class="space-y-2">
                        <div class="detail-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div class="flex justify-between">
                                <span>1ë‹¨ìœ„:</span>
                                <span id="sm1_1" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div class="flex justify-between">
                                <span>2ë‹¨ìœ„:</span>
                                <span id="sm1_2" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div class="flex justify-between">
                                <span>3ë‹¨ìœ„:</span>
                                <span id="sm1_3" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div class="flex justify-between">
                                <span>4ë‹¨ìœ„:</span>
                                <span id="sm1_4" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div class="flex justify-between">
                                <span>5ë‹¨ìœ„:</span>
                                <span id="sm1_5" class="font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="detail-card" style="background: white; border: 2px solid #eab308; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-yellow-700 flex items-center gap-2">
                        <span>âš« SM2ë¼ì¸</span>
                    </h4>
                    <div class="space-y-2">
                        <div class="detail-item" style="background: #fef9c3; padding: 10px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div class="flex justify-between">
                                <span>1ë‹¨ìœ„:</span>
                                <span id="sm2_1" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fef9c3; padding: 10px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div class="flex justify-between">
                                <span>2ë‹¨ìœ„:</span>
                                <span id="sm2_2" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fef9c3; padding: 10px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div class="flex justify-between">
                                <span>3ë‹¨ìœ„:</span>
                                <span id="sm2_3" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fef9c3; padding: 10px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div class="flex justify-between items-center">
                                <span>4ë‹¨ìœ„ <span class="text-red-600 text-sm">â† 1ì°¨ ë§¤ìˆ˜</span></span>
                                <span id="sm2_4" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fef9c3; padding: 10px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div class="flex justify-between items-center">
                                <span>5ë‹¨ìœ„ <span class="text-red-600 text-sm">â† 2ì°¨ ë§¤ìˆ˜</span></span>
                                <span id="sm2_5" class="font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="detail-card" style="background: white; border: 2px solid #f97316; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-orange-700 flex items-center gap-2">
                        <span>âš« SM3ë¼ì¸</span>
                    </h4>
                    <div class="space-y-2">
                        <div class="detail-item" style="background: #fed7aa; padding: 10px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div class="flex justify-between">
                                <span>1ë‹¨ìœ„:</span>
                                <span id="sm3_1" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fed7aa; padding: 10px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div class="flex justify-between">
                                <span>2ë‹¨ìœ„:</span>
                                <span id="sm3_2" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fed7aa; padding: 10px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div class="flex justify-between">
                                <span>3ë‹¨ìœ„:</span>
                                <span id="sm3_3" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fed7aa; padding: 10px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div class="flex justify-between items-center">
                                <span>4ë‹¨ìœ„ <span class="text-red-600 text-sm">â† 3ì°¨ ë§¤ìˆ˜</span></span>
                                <span id="sm3_4" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fed7aa; padding: 10px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div class="flex justify-between items-center">
                                <span>5ë‹¨ìœ„ <span class="text-red-600 text-sm">â† 4ì°¨ ë§¤ìˆ˜</span></span>
                                <span id="sm3_5" class="font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="detail-card" style="background: white; border: 2px solid #dc2626; border-radius: 12px;">
                    <h4 class="font-bold mb-3 text-red-700 flex items-center gap-2">
                        <span>âš« SM4ë¼ì¸ (ì†ì ˆë¼ì¸)</span>
                    </h4>
                    <div class="space-y-2">
                        <div class="detail-item" style="background: #fecdd3; padding: 10px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div class="flex justify-between">
                                <span>1ë‹¨ìœ„:</span>
                                <span id="sm4_1" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fecdd3; padding: 10px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div class="flex justify-between items-center">
                                <span>2ë‹¨ìœ„ <span class="text-gray-700 text-sm">â† ì†ì ˆ</span></span>
                                <span id="sm4_2" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fecdd3; padding: 10px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div class="flex justify-between">
                                <span>3ë‹¨ìœ„:</span>
                                <span id="sm4_3" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fecdd3; padding: 10px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div class="flex justify-between">
                                <span>4ë‹¨ìœ„:</span>
                                <span id="sm4_4" class="font-bold"></span>
                            </div>
                        </div>
                        <div class="detail-item" style="background: #fecdd3; padding: 10px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div class="flex justify-between">
                                <span>5ë‹¨ìœ„:</span>
                                <span id="sm4_5" class="font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Socket.IO ì‹¤ì‹œê°„ ì—°ê²° =====
        const socket = io('http://localhost:5000', {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity
        });
        
        // ì—°ê²° ìƒíƒœ
        socket.on('connect', () => {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
            updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
            registerAllStocks();
        });
        
        socket.on('disconnect', (reason) => {
            console.log('âŒ WebSocket ì—°ê²° ëŠê¹€:', reason);
            updateAPIStatus('disconnected', 'ì¬ì—°ê²° ì‹œë„ ì¤‘...');
            
            // ì„œë²„ê°€ ê°•ì œ ì¢…ë£Œí•œ ê²½ìš° ìˆ˜ë™ ì¬ì—°ê²°
            if (reason === 'io server disconnect') {
                setTimeout(() => {
                    console.log('ğŸ”„ ìˆ˜ë™ ì¬ì—°ê²° ì‹œë„...');
                    socket.connect();
                }, 3000);
            }
        });
        
        socket.on('connection_status', (data) => {
            if (data.logged_in) {
                updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
            } else {
                updateAPIStatus('disconnected', 'í‚¤ì›€ API ë¡œê·¸ì¸ í•„ìš”');
            }
        });
        
        // ì‹¤ì‹œê°„ ì‹œì„¸ ìˆ˜ì‹  (ìˆ˜ì •ë¨: ë„ë‹¬ í‘œì‹œ ê³ ì •)
        socket.on('realtime_update', (data) => {
            const { code, name, data: priceData } = data;
            
            const stock = stockDatabase.find(s => s.code === code);
            if (stock) {
                stock.currentPrice = priceData.current_price;
                stock.changeRate = priceData.change_rate;
                
                // ê°€ê²© ê³„ì‚°ì„ ìœ„í•œ ê¸°ë³¸ ì •ë³´ í™•ì¸
                if (stock.high && stock.low) {
                    const effectiveLow = stock.adjusted || stock.low;
                    const priceDiff = stock.high - stock.low;
                    const unit = priceDiff / 4;
                    
                    const buy1 = adjustBuyPrice(effectiveLow - unit * 3);
                    const buy2 = adjustBuyPrice(effectiveLow - unit * 4);
                    const buy3 = adjustBuyPrice(buy2 - unit * 3);
                    const buy4 = adjustBuyPrice(buy2 - unit * 4);
                    
                    if (!stock.reachedFlags) {
                        stock.reachedFlags = [false, false, false, false];
                    }
                    
                    // ë„ë‹¬ ì—¬ë¶€ ì²´í¬ (í•œë²ˆ ë„ë‹¬í•˜ë©´ true ìœ ì§€)
                    if (stock.currentPrice <= buy1 * 1.002) stock.reachedFlags[0] = true;
                    if (stock.currentPrice <= buy2 * 1.002) stock.reachedFlags[1] = true;
                    if (stock.currentPrice <= buy3 * 1.002) stock.reachedFlags[2] = true;
                    if (stock.currentPrice <= buy4 * 1.002) stock.reachedFlags[3] = true;
                }
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderStockList();
                
                // ìƒì„¸ ì •ë³´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                const detailCard = document.getElementById('stockDetail');
                if (detailCard.style.display === 'block') {
                    const detailName = document.getElementById('detailStockName').textContent;
                    if (detailName === stock.name) {
                        showStockDetail(stockDatabase.indexOf(stock));
                    }
                }
            }
        });
        
        // ë§¤ìˆ˜íƒ€ì  ì•Œë¦¼ ìˆ˜ì‹ 
        socket.on('price_alert', (data) => {
            const { name, current_price, buy_point, diff_percent, type, status } = data;
            
            console.log('ğŸ”” ì•Œë¦¼ ìˆ˜ì‹ :', data);
            
            const message = `
                <strong>${name}</strong><br>
                í˜„ì¬ê°€: â‚©${current_price.toLocaleString()}<br>
                ë§¤ìˆ˜íƒ€ì : â‚©${buy_point.toLocaleString()}<br>
                ì°¨ì´: ${diff_percent > 0 ? '+' : ''}${diff_percent.toFixed(2)}%
            `;
            
            showAlertToast(message, type);
        });
        
        // ë“±ë¡ ì„±ê³µ ë©”ì‹œì§€
        socket.on('registration_success', (data) => {
            console.log('âœ… ì‹¤ì‹œê°„ ë“±ë¡ ì„±ê³µ:', data.message);
            updateAPIStatus('connected', `ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ (${data.stocks.length}ê°œ)`);
        });
        
        // ì—ëŸ¬ ë©”ì‹œì§€
        socket.on('error', (data) => {
            console.error('âŒ ì˜¤ë¥˜:', data.message);
            alert(`ì˜¤ë¥˜: ${data.message}`);
        });
        
        function updateAPIStatus(status, text) {
            const statusElement = document.getElementById('apiStatus');
            const textElement = document.getElementById('apiStatusText');
            
            statusElement.className = `api-status ${status}`;
            textElement.textContent = text;
        }
        
        function registerAllStocks() {
            if (!socket || !socket.connected) {
                console.log('âš ï¸  WebSocket ì—°ê²° ì•ˆ ë¨');
                return;
            }
            
            const stocksToRegister = stockDatabase
                .filter(s => s.code)
                .map(s => {
                    // 1ì°¨ ë§¤ìˆ˜íƒ€ì  ê³„ì‚° (SM2ë¼ì¸ 4ë‹¨ìœ„)
                    let buyPoint = null;
                    if (s.high && s.low) {
                        const effectiveLow = s.adjusted || s.low;
                        const priceDiff = s.high - s.low;
                        const unit = priceDiff / 4;
                        buyPoint = Math.round(effectiveLow - unit * 3);
                    }
                    
                    return {
                        code: s.code, 
                        name: s.name,
                        buy_point: buyPoint
                    };
                });
            
            if (stocksToRegister.length > 0) {
                socket.emit('register_stocks', { source: 'SM3', stocks: stocksToRegister });
                console.log(`ğŸ“¡ ì‹¤ì‹œê°„ ì‹œì„¸ ë“±ë¡: ${stocksToRegister.length}ê°œ ì¢…ëª©`);
            } else {
                console.log('ë“±ë¡í•  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
            }
        }
        
        function updateStockPrice(data) {
            // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ(í˜¸í™˜ì„± ìœ„í•´ ìœ ì§€), ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëŠ” ìœ„ socket.onì—ì„œ ì²˜ë¦¬ë¨
            const stock = stockDatabase.find(s => s.code === data.code);
            if (!stock) return;
            
            const currentPrice = parseInt(data.current_price.replace(/[^\d]/g, ''));
            const changeRate = parseFloat(data.change_rate);
            
            stock.currentPrice = currentPrice;
            stock.changeRate = changeRate;
            
            renderStockList();
        }
        
        // ===== ê°€ê²© í¬ë§·íŒ… í•¨ìˆ˜ =====
        function formatPrice(price) {
            return `â‚©${Math.round(price).toLocaleString('ko-KR')}`;
        }
        
        function formatInputPrice(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('ko-KR');
            }
        }
        
        function parsePrice(priceStr) {
            return parseInt(priceStr.replace(/[^\d]/g, '')) || 0;
        }
        
        // ===== ê°€ê²© ì¡°ì • í•¨ìˆ˜ =====
        function adjustBuyPrice(price) {
            if (price < 1000) return Math.floor(price);
            if (price < 5000) return Math.floor(price / 5) * 5;
            if (price < 10000) return Math.floor(price / 10) * 10;
            if (price < 50000) return Math.floor(price / 50) * 50;
            if (price < 100000) return Math.floor(price / 100) * 100;
            if (price < 500000) return Math.floor(price / 500) * 500;
            return Math.floor(price / 1000) * 1000;
        }
        
        function adjustSellPrice(price) {
            if (price < 1000) return Math.ceil(price);
            if (price < 5000) return Math.ceil(price / 5) * 5;
            if (price < 10000) return Math.ceil(price / 10) * 10;
            if (price < 50000) return Math.ceil(price / 50) * 50;
            if (price < 100000) return Math.ceil(price / 100) * 100;
            if (price < 500000) return Math.ceil(price / 500) * 500;
            return Math.ceil(price / 1000) * 1000;
        }
        
        // ===== ê·¼ì ‘ë„ ì²´í¬ í•¨ìˆ˜ (3ë‹¨ê³„: close, equal, below) =====
        function checkProximity(currentPrice, targetPrice) {
            if (!currentPrice || !targetPrice) {
                return { isClose: false, isEqual: false, isBelow: false, percentage: 0 };
            }
            
            const diff = currentPrice - targetPrice;
            const percentage = (diff / targetPrice) * 100;
            
            // ë„ë‹¬ ì´í•˜ (í˜„ì¬ê°€ < íƒ€ì ê°€)
            if (diff < 0) {
                return { isClose: false, isEqual: false, isBelow: true, percentage: percentage.toFixed(2) };
            }
            
            // ë„ë‹¬ (í˜„ì¬ê°€ â‰ˆ íƒ€ì ê°€, 0~0.3%)
            if (percentage >= 0 && percentage <= 0.3) {
                return { isClose: false, isEqual: true, isBelow: false, percentage: percentage.toFixed(2) };
            }
            
            // ê·¼ì ‘ (0.3~1.0%)
            if (percentage > 0.3 && percentage <= 1.0) {
                return { isClose: true, isEqual: false, isBelow: false, percentage: percentage.toFixed(2) };
            }
            
            return { isClose: false, isEqual: false, isBelow: false, percentage: percentage.toFixed(2) };
        }
        
        // ===== ì „ì—­ ë³€ìˆ˜ =====
        let stockDatabase = JSON.parse(localStorage.getItem('smStocks')) || [];
        let currentSelectedIndex = -1;
        let draggedIndex = null;
        
        // ===== êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê´€ë ¨ =====
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let driveFileId = null;  // êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ID ì €ì¥
        const DRIVE_FILENAME = 'sm_stocks_data.json';
        
        // ===== í† í° ê°±ì‹  íƒ€ì´ë¨¸ ë³€ìˆ˜ =====
        let tokenRefreshTimer = null;
        let isSignedIn = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
        }
        
        function handleGoogleAuth() {
            if (accessToken) {
                signOut();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = gapi.client.getToken().access_token;
                    localStorage.setItem('google_access_token', accessToken);
                    
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry', expiryTime.toString());
                        setupTokenRefresh(resp.expires_in);
                    } else {
                        localStorage.setItem('google_token_expiry', (Date.now() + 3600000).toString());
                        setupTokenRefresh(3600);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±');
                    document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('backupBtn').classList.remove('bg-gray-400');
                    document.getElementById('backupBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                    document.getElementById('loadBtn').disabled = false;
                    document.getElementById('loadBtn').classList.remove('bg-gray-400');
                    document.getElementById('loadBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
                    
                    await loadFromGoogleDrive();
                };
                
                tokenClient.requestAccessToken({prompt: 'consent'});
            }
        }
        
        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
                localStorage.removeItem('google_access_token');
                localStorage.removeItem('google_token_expiry');
                
                if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
                isSignedIn = false;
                
                updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
                document.getElementById('googleBtnText').textContent = 'ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸';
                document.getElementById('backupBtn').disabled = true;
                document.getElementById('backupBtn').classList.add('bg-gray-400');
                document.getElementById('backupBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
                document.getElementById('loadBtn').disabled = true;
                document.getElementById('loadBtn').classList.add('bg-gray-400');
                document.getElementById('loadBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
        
        // ========== í† í° ìë™ ê°±ì‹  ì„¤ì • ==========
        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
            
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                accessToken = resp.access_token;
                                localStorage.setItem('google_access_token', accessToken);
                                if (resp.expires_in) {
                                    localStorage.setItem('google_token_expiry', (Date.now() + (resp.expires_in * 1000)).toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                gapi.client.setToken({ access_token: accessToken });
                                console.log('í† í° ê°±ì‹  ì™„ë£Œ');
                            } else {
                                throw new Error(resp.error);
                            }
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ê°±ì‹  ì‹¤íŒ¨:', err);
                        alert("âš ï¸ êµ¬ê¸€ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        signOut();
                    }
                }
            }, refreshTime);
        }

        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token');
            const expiry = localStorage.getItem('google_token_expiry');
            
            if (savedToken && expiry && Date.now() < parseInt(expiry)) {
                gapi.client.setToken({access_token: savedToken});
                accessToken = savedToken;
                isSignedIn = true;
                
                const remainingSeconds = Math.floor((parseInt(expiry) - Date.now()) / 1000);
                setupTokenRefresh(remainingSeconds);
                
                driveFileId = await findDriveFile(DRIVE_FILENAME);
                
                updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±');
                document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                document.getElementById('backupBtn').disabled = false;
                document.getElementById('backupBtn').classList.remove('bg-gray-400');
                document.getElementById('backupBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('loadBtn').classList.remove('bg-gray-400');
                document.getElementById('loadBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else if (savedToken) {
                tryAutoRelogin();
            }
        }
        
        function tryAutoRelogin() {
            if (tokenClient) {
                tokenClient.callback = async (resp) => {
                    if (resp.error === undefined) {
                        accessToken = gapi.client.getToken().access_token;
                        localStorage.setItem('google_access_token', accessToken);
                        
                        if (resp.expires_in) {
                            localStorage.setItem('google_token_expiry', (Date.now() + (resp.expires_in * 1000)).toString());
                            setupTokenRefresh(resp.expires_in);
                        } else {
                            localStorage.setItem('google_token_expiry', (Date.now() + 3600000).toString());
                            setupTokenRefresh(3600);
                        }
                        
                        isSignedIn = true;
                        
                        driveFileId = await findDriveFile(DRIVE_FILENAME);
                        
                        updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±');
                        document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                        document.getElementById('backupBtn').disabled = false;
                        document.getElementById('backupBtn').classList.remove('bg-gray-400');
                        document.getElementById('backupBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                        document.getElementById('loadBtn').disabled = false;
                        document.getElementById('loadBtn').classList.remove('bg-gray-400');
                        document.getElementById('loadBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                };
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function updateSyncStatus(status, text) {
            const statusElement = document.getElementById('syncStatus');
            const textElement = document.getElementById('statusText');
            
            statusElement.className = `sync-status ${status}`;
            textElement.textContent = text;
        }
        
        async function saveToGoogleDrive() {
            if (!accessToken) return;
            
            try {
                updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                
                if (!driveFileId) {
                    driveFileId = await findDriveFile(DRIVE_FILENAME);
                }
                
                const content = JSON.stringify(stockDatabase, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                
                const metadata = {
                    name: DRIVE_FILENAME,
                    mimeType: 'application/json'
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                if (driveFileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: form
                    });
                } else {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: form
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', 'ì €ì¥ ì™„ë£Œ');
                updateLastSyncTime();
                setTimeout(() => updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±'), 2000);
            } catch (error) {
                console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì €ì¥ ì˜¤ë¥˜:', error);
                updateSyncStatus('connected', 'ì €ì¥ ì˜¤ë¥˜');
                setTimeout(() => updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±'), 2000);
            }
        }
        
        async function loadFromGoogleDrive() {
            if (!accessToken) return;
            
            try {
                updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                if (!driveFileId) {
                    driveFileId = await findDriveFile(DRIVE_FILENAME);
                }
                
                if (!driveFileId) {
                    updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±');
                    return false;
                }
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    stockDatabase = data;
                    localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                    registerAllStocks();
                    updateSyncStatus('connected', 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
                    updateLastSyncTime();
                    setTimeout(() => updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±'), 2000);
                    return true;
                } else {
                    throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                updateSyncStatus('connected', 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜');
                setTimeout(() => updateSyncStatus('connected', 'ë™ê¸°í™” í™œì„±'), 2000);
                return false;
            }
        }
        
        async function findDriveFile(filename) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${filename}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                const files = response.result.files;
                return files && files.length > 0 ? files[0].id : null;
            } catch (error) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${now.toLocaleString('ko-KR')}`;
            document.getElementById('lastSyncTime').textContent = timeStr;
        }
        
        async function manualBackup() {
            if (!accessToken) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        async function manualLoad() {
            if (!accessToken) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë¡œì»¬ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°ë©ë‹ˆë‹¤.')) {
                const success = await loadFromGoogleDrive();
                if (success) {
                    alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ===== ê³„ì‚° ë° UI í•¨ìˆ˜ =====
        function calculate() {
            const stockName = document.getElementById('stockName').value.trim();
            const high = parsePrice(document.getElementById('highPrice').value);
            const low = parsePrice(document.getElementById('lowPrice').value);
            const bounce = parsePrice(document.getElementById('bouncePrice').value) || null;
            const adjusted = parsePrice(document.getElementById('adjustedPrice').value) || null;
            
            if (!stockName || high === 0 || low === 0) {
                alert('ì¢…ëª©ëª…, ê³ ê°€, ì €ê°€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (high <= low) {
                alert('ê³ ê°€ëŠ” ì €ê°€ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const effectiveLow = adjusted !== null ? adjusted : low;
            const priceDiff = high - low;
            const unit = priceDiff / 4;
            
            const buy1 = adjustBuyPrice(effectiveLow - unit * 3);
            const buy2 = adjustBuyPrice(effectiveLow - unit * 4);
            const buy3 = adjustBuyPrice(buy2 - unit * 3);
            const buy4 = adjustBuyPrice(buy2 - unit * 4);
            const stopLoss = adjustSellPrice(buy4 - unit);
            
            alert(`ê³„ì‚° ì™„ë£Œ!\n\n` +
                  `1ì°¨ ë§¤ìˆ˜: ${formatPrice(buy1)}\n` +
                  `2ì°¨ ë§¤ìˆ˜: ${formatPrice(buy2)}\n` +
                  `3ì°¨ ë§¤ìˆ˜: ${formatPrice(buy3)}\n` +
                  `4ì°¨ ë§¤ìˆ˜: ${formatPrice(buy4)}\n` +
                  `ì†ì ˆ: ${formatPrice(stopLoss)}`);
        }
        
        function resetInputs() {
            document.getElementById('stockName').value = '';
            document.getElementById('stockCode').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('adjustedPrice').value = '';
            currentSelectedIndex = -1;
            renderStockList();
            hideStockDetail();
        }
        
        function addToList() {
            const stockName = document.getElementById('stockName').value.trim();
            const stockCode = document.getElementById('stockCode').value.trim();
            const high = parsePrice(document.getElementById('highPrice').value);
            const low = parsePrice(document.getElementById('lowPrice').value);
            const bounce = parsePrice(document.getElementById('bouncePrice').value) || null;
            const adjusted = parsePrice(document.getElementById('adjustedPrice').value) || null;
            
            if (!stockName || high === 0 || low === 0) {
                alert('ì¢…ëª©ëª…, ê³ ê°€, ì €ê°€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (high <= low) {
                alert('ê³ ê°€ëŠ” ì €ê°€ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const stockData = {
                name: stockName,
                code: stockCode || null,
                high: high,
                low: low,
                bounce: bounce,
                adjusted: adjusted,
                timestamp: new Date().toISOString(),
                currentPrice: null,
                changeRate: 0,
                reachedFlags: [false, false, false, false]
            };
            
            const existingIndex = stockDatabase.findIndex(stock => stock.name === stockName);
            
            if (existingIndex !== -1) {
                stockDatabase[existingIndex] = stockData;
                alert(`"${stockName}" ì¢…ëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                stockDatabase.unshift(stockData);
                alert(`"${stockName}" ì¢…ëª©ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
            
            localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
            saveToGoogleDrive();
            renderStockList();
            
            if (stockCode && socket && socket.connected) {
                socket.emit('register_stocks', { 
                    stocks: [{ 
                        code: stockCode, 
                        name: stockName,
                        buy_point: null 
                    }] 
                });
            }
        }
        
        function renderStockList() {
            const container = document.getElementById('stockList');
            
            if (stockDatabase.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="p-3 text-center">â‹®â‹®</th>
                                <th class="p-3 text-left">ì¢…ëª©ëª…</th>
                                <th class="p-3 text-center text-red-600">1ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center text-red-600">2ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center text-red-600">3ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center text-red-600">4ì°¨ë§¤ìˆ˜</th>
                                <th class="p-3 text-center text-blue-600">1ì°¨ë§¤ë„</th>
                                <th class="p-3 text-center text-blue-600">2ì°¨ë§¤ë„</th>
                                <th class="p-3 text-center text-gray-600">ì†ì ˆ</th>
                                <th class="p-3 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stockDatabase.map((stock, index) => {
                                const effectiveLow = stock.adjusted !== null ? stock.adjusted : stock.low;
                                const priceDiff = stock.high - stock.low;
                                const unit = priceDiff / 4;
                                
                                const buy1 = adjustBuyPrice(effectiveLow - unit * 3);
                                const buy2 = adjustBuyPrice(effectiveLow - unit * 4);
                                const buy3 = adjustBuyPrice(buy2 - unit * 3);
                                const buy4 = adjustBuyPrice(buy2 - unit * 4);
                                const stopLoss = adjustSellPrice(buy4 - unit);
                                
                                const selected = currentSelectedIndex === index ? 'bg-purple-200' : '';
                                
                                let priceInfo = '';
                                if (stock.currentPrice) {
                                    const arrow = stock.changeRate > 0 ? 'â–²' : stock.changeRate < 0 ? 'â–¼' : '';
                                    const priceClass = stock.changeRate > 0 ? 'price-up' : stock.changeRate < 0 ? 'price-down' : 'price-flat';
                                    priceInfo = `<br><span class="text-xs">
                                        <span class="realtime-price ${priceClass}">â‚©${stock.currentPrice.toLocaleString('ko-KR')}</span>
                                        <span class="realtime-price-change ${priceClass}">${arrow} ${stock.changeRate.toFixed(2)}%</span>
                                    </span>`;
                                }
                                
                                const proximity1 = checkProximity(stock.currentPrice, buy1);
                                const proximity2 = checkProximity(stock.currentPrice, buy2);
                                const proximity3 = checkProximity(stock.currentPrice, buy3);
                                const proximity4 = checkProximity(stock.currentPrice, buy4);
                                
                                if (!stock.reachedFlags) {
                                    stock.reachedFlags = [false, false, false, false];
                                }
                                
                                const reached1 = stock.reachedFlags[0];
                                const reached2 = stock.reachedFlags[1];
                                const reached3 = stock.reachedFlags[2];
                                const reached4 = stock.reachedFlags[3];
                                
                                const proximityClass1 = proximity1.isClose ? 'proximity-box' : '';
                                let buy1Display;
                                if (proximity1.isBelow || reached1) {
                                    buy1Display = `<div class="proximity-box-below">${formatPrice(buy1)}</div>`;
                                } else if (proximity1.isEqual) {
                                    buy1Display = `<div class="proximity-box-equal">${formatPrice(buy1)}</div>`;
                                } else if (proximity1.isClose) {
                                    buy1Display = `<div class="proximity-box">${formatPrice(buy1)}</div>`;
                                } else {
                                    buy1Display = formatPrice(buy1);
                                }
                                
                                const proximityClass2 = proximity2.isClose ? 'proximity-box' : '';
                                let buy2Display;
                                if (proximity2.isBelow || reached2) {
                                    buy2Display = `<div class="proximity-box-below">${formatPrice(buy2)}</div>`;
                                } else if (proximity2.isEqual) {
                                    buy2Display = `<div class="proximity-box-equal">${formatPrice(buy2)}</div>`;
                                } else if (proximity2.isClose) {
                                    buy2Display = `<div class="proximity-box">${formatPrice(buy2)}</div>`;
                                } else {
                                    buy2Display = formatPrice(buy2);
                                }
                                
                                const proximityClass3 = proximity3.isClose ? 'proximity-box' : '';
                                let buy3Display;
                                if (proximity3.isBelow || reached3) {
                                    buy3Display = `<div class="proximity-box-below">${formatPrice(buy3)}</div>`;
                                } else if (proximity3.isEqual) {
                                    buy3Display = `<div class="proximity-box-equal">${formatPrice(buy3)}</div>`;
                                } else if (proximity3.isClose) {
                                    buy3Display = `<div class="proximity-box">${formatPrice(buy3)}</div>`;
                                } else {
                                    buy3Display = formatPrice(buy3);
                                }
                                
                                const proximityClass4 = proximity4.isClose ? 'proximity-box' : '';
                                let buy4Display;
                                if (proximity4.isBelow || reached4) {
                                    buy4Display = `<div class="proximity-box-below">${formatPrice(buy4)}</div>`;
                                } else if (proximity4.isEqual) {
                                    buy4Display = `<div class="proximity-box-equal">${formatPrice(buy4)}</div>`;
                                } else if (proximity4.isClose) {
                                    buy4Display = `<div class="proximity-box">${formatPrice(buy4)}</div>`;
                                } else {
                                    buy4Display = formatPrice(buy4);
                                }
                                
                                let sell1 = '-', sell2 = '-';
                                if (stock.bounce !== null) {
                                    const sellDiff = effectiveLow - stock.bounce;
                                    const sellUnit = sellDiff / 4;
                                    sell1 = formatPrice(adjustSellPrice(effectiveLow - sellUnit * 2));
                                    sell2 = formatPrice(adjustSellPrice(effectiveLow - sellUnit));
                                }
                                
                                const rowBgColor = index % 2 === 0 ? 'bg-white' : 'bg-purple-50';
                                
                                return `
                                    <tr class="${selected} ${rowBgColor} hover:bg-purple-100 cursor-pointer border-b transition-colors"
                                        draggable="false"
                                        ondragstart="handleDragStart(event, ${index})"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, ${index})"
                                        ondragend="handleDragEnd(event)"
                                        onclick="loadStock(${index})">
                                        <td class="drag-handle p-3" 
                                            onclick="event.stopPropagation()"
                                            onmouseover="this.parentElement.setAttribute('draggable', 'true')"
                                            onmouseout="this.parentElement.setAttribute('draggable', 'false')">â‹®â‹®</td>
                                        <td class="p-3 font-bold">${stock.name}${priceInfo}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${buy1Display}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${buy2Display}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${buy3Display}</td>
                                        <td class="p-3 text-center text-red-600 font-semibold">${buy4Display}</td>
                                        <td class="p-3 text-center text-blue-600 font-semibold">${sell1}</td>
                                        <td class="p-3 text-center text-blue-600 font-semibold">${sell2}</td>
                                        <td class="p-3 text-center text-gray-600 font-semibold">${formatPrice(stopLoss)}</td>
                                        <td class="p-3 text-center">
                                            <button class="delete-btn" onclick="deleteStock(${index}, event)">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedIndex === null || draggedIndex === targetIndex) {
                return false;
            }
            
            const draggedItem = stockDatabase[draggedIndex];
            stockDatabase.splice(draggedIndex, 1);
            stockDatabase.splice(targetIndex, 0, draggedItem);
            
            if (currentSelectedIndex === draggedIndex) {
                currentSelectedIndex = targetIndex;
            } else if (draggedIndex < currentSelectedIndex && targetIndex >= currentSelectedIndex) {
                currentSelectedIndex--;
            } else if (draggedIndex > currentSelectedIndex && targetIndex <= currentSelectedIndex) {
                currentSelectedIndex++;
            }
            
            localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
            saveToGoogleDrive();
            renderStockList();
            
            return false;
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }
        
        function loadStock(index) {
            if (draggedIndex !== null) return;
            
            currentSelectedIndex = index;
            const stock = stockDatabase[index];
            
            document.getElementById('stockName').value = stock.name || '';
            document.getElementById('stockCode').value = stock.code || '';
            document.getElementById('highPrice').value = stock.high ? stock.high.toLocaleString('ko-KR') : '';
            document.getElementById('lowPrice').value = stock.low ? stock.low.toLocaleString('ko-KR') : '';
            document.getElementById('bouncePrice').value = stock.bounce !== null && stock.bounce !== undefined ? stock.bounce.toLocaleString('ko-KR') : '';
            document.getElementById('adjustedPrice').value = stock.adjusted !== null && stock.adjusted !== undefined ? stock.adjusted.toLocaleString('ko-KR') : '';
            
            renderStockList();
            showStockDetail(index);
            document.getElementById('stockName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function showStockDetail(index) {
            const stock = stockDatabase[index];
            const effectiveLow = stock.adjusted !== null ? stock.adjusted : stock.low;
            const priceDiff = stock.high - stock.low;
            const unit = priceDiff / 4;
            
            const buy1 = adjustBuyPrice(effectiveLow - unit * 3);
            const buy2 = adjustBuyPrice(effectiveLow - unit * 4);
            const buy3 = adjustBuyPrice(buy2 - unit * 3);
            const buy4 = adjustBuyPrice(buy2 - unit * 4);
            const stopLoss = adjustSellPrice(buy4 - unit);
            
            document.getElementById('detailStockName').textContent = stock.name;
            document.getElementById('summaryStockName').textContent = stock.name;
            
            const priceRate = ((stock.high - effectiveLow) / effectiveLow) * 100;
            document.getElementById('summaryPriceRate').textContent = priceRate.toFixed(1) + '%';
            
            if (stock.bounce !== null) {
                const bounceRate = ((effectiveLow - stock.bounce) / stock.bounce) * 100;
                document.getElementById('summaryBounceRate').textContent = bounceRate.toFixed(1) + '%';
            } else {
                document.getElementById('summaryBounceRate').textContent = '-';
            }
            
            document.getElementById('summaryBuy1').textContent = formatPrice(buy1);
            document.getElementById('summaryBuy2').textContent = formatPrice(buy2);
            document.getElementById('summaryBuy3').textContent = formatPrice(buy3);
            document.getElementById('summaryBuy4').textContent = formatPrice(buy4);
            document.getElementById('summaryStopLoss').textContent = formatPrice(stopLoss);
            
            if (stock.bounce !== null) {
                const sellDiff = effectiveLow - stock.bounce;
                const sellUnit = sellDiff / 4;
                const sell1 = adjustSellPrice(effectiveLow - sellUnit * 2);
                const sell2 = adjustSellPrice(effectiveLow - sellUnit);
                
                const sell1BounceRate = ((sell1 - stock.bounce) / stock.bounce) * 100;
                const sell2BounceRate = ((sell2 - stock.bounce) / stock.bounce) * 100;
                
                document.getElementById('summarySell1').textContent = formatPrice(sell1);
                document.getElementById('summarySell2').textContent = formatPrice(sell2);
                
                document.getElementById('sell1Description').textContent = `(ë§¤ë„ë¼ì¸ 3ë‹¨ìœ„) (ë°˜ë“±í­ ${sell1BounceRate.toFixed(1)}%)`;
                document.getElementById('sell2Description').textContent = `(ë§¤ë„ë¼ì¸ 2ë‹¨ìœ„) (ë°˜ë“±í­ ${sell2BounceRate.toFixed(1)}%)`;
            } else {
                document.getElementById('summarySell1').textContent = '-';
                document.getElementById('summarySell2').textContent = '-';
                document.getElementById('sell1Description').textContent = '(ë§¤ë„ë¼ì¸ 3ë‹¨ìœ„)';
                document.getElementById('sell2Description').textContent = '(ë§¤ë„ë¼ì¸ 2ë‹¨ìœ„)';
            }
            
            document.getElementById('sm1_1').textContent = formatPrice(stock.high);
            document.getElementById('sm1_2').textContent = formatPrice(stock.high - unit);
            document.getElementById('sm1_3').textContent = formatPrice(stock.high - unit * 2);
            document.getElementById('sm1_4').textContent = formatPrice(stock.high - unit * 3);
            document.getElementById('sm1_5').textContent = formatPrice(effectiveLow);
            
            document.getElementById('sm2_1').textContent = formatPrice(effectiveLow);
            document.getElementById('sm2_2').textContent = formatPrice(effectiveLow - unit);
            document.getElementById('sm2_3').textContent = formatPrice(effectiveLow - unit * 2);
            document.getElementById('sm2_4').textContent = formatPrice(buy1);
            document.getElementById('sm2_5').textContent = formatPrice(buy2);
            
            document.getElementById('sm3_1').textContent = formatPrice(buy2);
            document.getElementById('sm3_2').textContent = formatPrice(buy2 - unit);
            document.getElementById('sm3_3').textContent = formatPrice(buy2 - unit * 2);
            document.getElementById('sm3_4').textContent = formatPrice(buy3);
            document.getElementById('sm3_5').textContent = formatPrice(buy4);
            
            document.getElementById('sm4_1').textContent = formatPrice(buy4);
            document.getElementById('sm4_2').textContent = formatPrice(stopLoss);
            document.getElementById('sm4_3').textContent = formatPrice(buy4 - unit * 2);
            document.getElementById('sm4_4').textContent = formatPrice(buy4 - unit * 3);
            document.getElementById('sm4_5').textContent = formatPrice(buy4 - unit * 4);
            
            if (stock.bounce !== null) {
                const sellDiff = effectiveLow - stock.bounce;
                const sellUnit = sellDiff / 4;
                
                document.getElementById('sell_line_1').textContent = formatPrice(effectiveLow);
                document.getElementById('sell_line_2').textContent = formatPrice(adjustSellPrice(effectiveLow - sellUnit));
                document.getElementById('sell_line_3').textContent = formatPrice(adjustSellPrice(effectiveLow - sellUnit * 2));
                document.getElementById('sell_line_4').textContent = formatPrice(effectiveLow - sellUnit * 3);
                document.getElementById('sell_line_5').textContent = formatPrice(stock.bounce);
            } else {
                document.getElementById('sell_line_1').textContent = '-';
                document.getElementById('sell_line_2').textContent = '-';
                document.getElementById('sell_line_3').textContent = '-';
                document.getElementById('sell_line_4').textContent = '-';
                document.getElementById('sell_line_5').textContent = '-';
            }
            
            document.getElementById('stockDetail').style.display = 'block';
        }
        
        function hideStockDetail() {
            document.getElementById('stockDetail').style.display = 'none';
        }
        
        function deleteStock(index, event) {
            event.stopPropagation();
            
            const stock = stockDatabase[index];
            if (confirm(`"${stock.name}" ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                stockDatabase.splice(index, 1);
                localStorage.setItem('smStocks', JSON.stringify(stockDatabase));
                
                if (currentSelectedIndex === index) {
                    currentSelectedIndex = -1;
                    hideStockDetail();
                } else if (currentSelectedIndex > index) {
                    currentSelectedIndex--;
                }
                
                saveToGoogleDrive();
                renderStockList();
                registerAllStocks();
            }
        }
        
        window.onload = function() {
            renderStockList();
            gapiLoaded();
            gisLoaded();
            
            const priceInputs = ['highPrice', 'lowPrice', 'bouncePrice', 'adjustedPrice'];
            priceInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    formatInputPrice(this);
                });
            });
            
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
    
    <div id="alertModal" class="alert-modal">
        <div class="alert-modal-content">
            <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ”” ì•Œë¦¼ ì„¤ì •</h2>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="font-semibold">ì•Œë¦¼ìŒ í™œì„±í™”</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundAlertToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div>
                    <label class="font-semibold block mb-2">ì•Œë¦¼ ë¯¼ê°ë„ (ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ %)</label>
                    <input type="number" id="alertThreshold" value="2" min="0.5" max="10" step="0.5" 
                           class="border-2 border-gray-300 rounded-lg px-4 py-2 w-full">
                    <p class="text-sm text-gray-600 mt-1">ë§¤ìˆ˜íƒ€ì ì—ì„œ Â±ì´ ë²”ìœ„ ë‚´ì— ì˜¤ë©´ ì•Œë¦¼</p>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-900 mb-2">ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼</h3>
                    <p class="text-sm text-blue-800">
                        í…”ë ˆê·¸ë¨ ì•Œë¦¼ì€ ì„œë²„(app.py)ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
                    </p>
                </div>
                
                <button onclick="testAlertSound()" 
                        class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                    ğŸ”Š ì•Œë¦¼ìŒ í…ŒìŠ¤íŠ¸
                </button>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveAlertSettings()" 
                        class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                    ì €ì¥
                </button>
                <button onclick="closeAlertSettings()" 
                        class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let soundAlertEnabled = true;
        let alertThreshold = 2.0;
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playAlertSound() {
            if (!soundAlertEnabled) return;
            try {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.frequency.value = 1000;
                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.2);
                }, 150);
            } catch (e) {
                console.error('ì•Œë¦¼ìŒ ì¬ìƒ ì˜¤ë¥˜:', e);
            }
        }
        
        function testAlertSound() {
            playAlertSound();
        }
        
        function showAlertToast(message, type = 'near') {
            const existingToast = document.querySelector('.alert-toast');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = 'alert-toast';
            toast.innerHTML = `
                <div class="font-bold mb-1">${type === 'reached' ? 'ğŸ¯ ë§¤ìˆ˜íƒ€ì  ë„ë‹¬!' : 'âš ï¸ ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘!'}</div>
                <div class="text-sm">${message}</div>
            `;
            document.body.appendChild(toast);
            playAlertSound();
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        function openAlertSettings() {
            document.getElementById('alertModal').classList.add('active');
            soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
            alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
            document.getElementById('soundAlertToggle').checked = soundAlertEnabled;
            document.getElementById('alertThreshold').value = alertThreshold;
        }
        
        function closeAlertSettings() {
            document.getElementById('alertModal').classList.remove('active');
        }
        
        function saveAlertSettings() {
            soundAlertEnabled = document.getElementById('soundAlertToggle').checked;
            alertThreshold = parseFloat(document.getElementById('alertThreshold').value);
            localStorage.setItem('soundAlertEnabled', soundAlertEnabled);
            localStorage.setItem('alertThreshold', alertThreshold);
            if (socket && socket.connected) {
                socket.emit('update_alert_config', { threshold: alertThreshold });
            }
            alert('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeAlertSettings();
        }
        
        soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
        alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
    </script>
</body>
</html>